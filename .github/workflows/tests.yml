name: tests

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read
  checks: read
  deployments: read
  discussions: read
  packages: read
  repository-projects: read
  security-events: read
  statuses: read

on: [push, pull_request]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck on reconftw.sh
        run: shellcheck -S warning reconftw.sh

      - name: Run ShellCheck on modules
        run: shellcheck -S warning modules/*.sh
        continue-on-error: true

      - name: Run ShellCheck on install.sh
        run: shellcheck -S warning install.sh
        continue-on-error: true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local

      - name: Run unit tests
        run: bats tests/unit/*.bats

  tests:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest

    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Install bash from homebrew
        if: ${{ startsWith(matrix.os, 'macos-') }}
        run: brew install bash

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # full history for git describe

      - name: Fetch tags
        run: git fetch --force --prune --tags

      - name: Install reconFTW
        shell: bash
        continue-on-error: true
        run: ./install.sh

      - name: Check if all tools are installed
        shell: bash
        run: ./reconftw.sh --check-tools || true

      - name: Check if chromium dependencies are installed
        shell: bash
        run: nuclei -headless -id screenshot
