#!/bin/bash

# Load environment variables from reconftw.cfg
# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

help_menu() {
    echo "Usage: $0 [DOMAIN] [OPTIONS]"
    echo "Web probing tool for non-standard ports for the specified domain."
    echo
    echo "Options:"
    echo "  -h, --help   Display this help menu and exit"
    echo "  -f, --force  Force the execution even if it was already processed"
}

validate_inputs() {
    if [[ -z "$domain" ]]; then
        echo -e "${yellow} No domain provided! ${reset}"
        exit 1
    fi

    if [ "$WEBPROBEFULL" != true ] && [ "$FORCE_EXECUTION" != true ]; then
        echo -e "${yellow} webprobe_full skipped in this mode or defined in reconftw.cfg ${reset}"
        exit 0
    fi
}

run_webprobe_full() {
    start_func "webprobe_full" "Http probing non-standard ports"
    if [ -s "subdomains/subdomains.txt" ]; then
        if [ ! "$AXIOM" = true ]; then
            cat subdomains/subdomains.txt | httpx -follow-host-redirects -random-agent -status-code -p $UNCOMMON_PORTS_WEB -threads $HTTPX_UNCOMMONPORTS_THREADS -timeout $HTTPX_UNCOMMONPORTS_TIMEOUT -silent -retries 2 -title -web-server -tech-detect -location -no-color -json -o .tmp/web_full_info_uncommon.txt 2>>"$LOGFILE" >/dev/null
        else
            axiom-scan subdomains/subdomains.txt -m httpx -follow-host-redirects -H \"${HEADER}\" -status-code -p $UNCOMMON_PORTS_WEB -threads $HTTPX_UNCOMMONPORTS_THREADS -timeout $HTTPX_UNCOMMONPORTS_TIMEOUT -silent -retries 2 -title -web-server -tech-detect -location -no-color -json -o .tmp/web_full_info_uncommon.txt $AXIOM_EXTRA_ARGS 2>>"$LOGFILE" >/dev/null
        fi
    fi

    if [ -s ".tmp/web_full_info_uncommon.txt" ]; then
        cat .tmp/web_full_info_uncommon.txt | jq -r 'try .url' 2>/dev/null | grep "$domain" | sed "s/*.//" | anew -q .tmp/probed_uncommon_ports_tmp.txt
        cat .tmp/web_full_info_uncommon.txt | jq -r 'try . |"\(.url) [\(.status_code)] [\(.title)] [\(.webserver)] \(.tech)"' | anew -q webs/web_full_info_uncommon_plain.txt

        if [[ $domain =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9] ]]; then 
            cat .tmp/web_full_info_uncommon.txt 2>>"$LOGFILE" | anew -q webs/web_full_info_uncommon.txt
        else
            cat .tmp/web_full_info_uncommon.txt 2>>"$LOGFILE" | grep "$domain" | anew -q webs/web_full_info_uncommon.txt
        fi
    fi

    NUMOFLINES=$(cat .tmp/probed_uncommon_ports_tmp.txt 2>>"$LOGFILE" | anew webs/webs_uncommon_ports.txt | sed '/^$/d' | wc -l)
    notification "Uncommon web ports: ${NUMOFLINES} new websites" good
    [ -s "webs/webs_uncommon_ports.txt" ] && cat webs/webs_uncommon_ports.txt
    cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null | anew -q .tmp/webs_all.txt
    end_func "Results are saved in $domain/webs/webs_uncommon_ports.txt" "webprobe_full"
    
    if [ "$PROXY" = true ] && [ -n "$proxy_url" ] && [[ $(cat webs/webs_uncommon_ports.txt| wc -l) -le $DEEP_LIMIT2 ]]; then
        notification "Sending websites with uncommon ports to proxy" info
        ffuf -mc all -w webs/webs_uncommon_ports.txt -u FUZZ -replay-proxy $proxy_url 2>>"$LOGFILE" >/dev/null
    fi
}

# Main
FORCE_EXECUTION=false
domain="$1"

shift
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) help_menu; exit 0 ;;
        -f|--force) FORCE_EXECUTION=true; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

validate_inputs
run_webprobe_full
