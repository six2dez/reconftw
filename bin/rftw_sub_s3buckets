#!/bin/bash

# Load environment variables from reconftw.cfg
# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

help_menu() {
    echo "Usage: $0 [DOMAIN] [OPTIONS]"
    echo "AWS S3 buckets and cloud assets checker."
    echo
    echo "Options:"
    echo "  -h, --help   Display this help menu and exit"
    echo "  -f, --force  Force the execution even if it was already processed"
}

validate_inputs() {
    if [[ -z "$domain" ]]; then
        echo -e "${yellow} No domain provided! ${reset}"
        exit 1
    fi

    if [[ $domain =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9] ]]; then
        echo -e "${yellow} Invalid domain format: IP address provided instead of a domain name ${reset}"
        exit 1
    fi

    if [ "$S3BUCKETS" != true ] && [ "$FORCE_EXECUTION" != true ]; then
        echo -e "${yellow} s3buckets skipped in this mode or defined in reconftw.cfg ${reset}"
        exit 0
    fi
}

run_s3buckets() {
    start_func "s3buckets" "AWS S3 buckets search"
    # S3Scanner
    if [ ! "$AXIOM" = true ]; then
        [ -s "subdomains/subdomains.txt" ] && s3scanner scan -f subdomains/subdomains.txt 2>>"$LOGFILE" | anew -q .tmp/s3buckets.txt
    else
        axiom-scan subdomains/subdomains.txt -m s3scanner -o .tmp/s3buckets_tmp.txt $AXIOM_EXTRA_ARGS 2>>"$LOGFILE" >/dev/null
        [ -s ".tmp/s3buckets_tmp.txt" ] && cat .tmp/s3buckets_tmp.txt .tmp/s3buckets_tmp2.txt 2>>"$LOGFILE" | anew -q .tmp/s3buckets.txt && sed -i '/^$/d' .tmp/s3buckets.txt
    fi
    # Cloudenum
    keyword=${domain%%.*}
    python3 ~/Tools/cloud_enum/cloud_enum.py -k $keyword -qs -l .tmp/output_cloud.txt 2>>"$LOGFILE" >/dev/null

    NUMOFLINES1=$(cat .tmp/output_cloud.txt 2>>"$LOGFILE" | sed '/^#/d' | sed '/^$/d' | anew subdomains/cloud_assets.txt | wc -l)
    if [ "$NUMOFLINES1" -gt 0 ]; then
        notification "${NUMOFLINES1} new cloud assets found" info
    fi

    NUMOFLINES2=$(cat .tmp/s3buckets.txt 2>>"$LOGFILE" | grep -aiv "not_exist" | grep -aiv "Warning:" | grep -aiv "invalid_name" | grep -aiv "^http" | awk 'NF' | anew subdomains/s3buckets.txt | sed '/^$/d' | wc -l)
    if [ "$NUMOFLINES2" -gt 0 ]; then
        notification "${NUMOFLINES2} new S3 buckets found" info
    fi

    end_func "Results are saved in subdomains/s3buckets.txt and subdomains/cloud_assets.txt" "s3buckets"
}

# Main
FORCE_EXECUTION=false
domain="$1"

shift
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) help_menu; exit 0 ;;
        -f|--force) FORCE_EXECUTION=true; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

validate_inputs
run_s3buckets
