#!/bin/bash

# Load environment variables from reconftw.cfg
# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

# Help function
help_menu() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "CMS Scanner"
    echo ""
    echo "Options:"
    echo "  -h, --help            Show this help menu"
    echo "  -f, --force           Force the execution even if already processed"
}

# Start function
start_func() {
    echo "Starting $1: $2..."
}

# End function
end_func() {
    echo "$1"
    echo "End of $2..."
}

# Default values
FORCE=false

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) help_menu; exit 0 ;;
        -f|--force) FORCE=true ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

if { [ ! -f "$called_fn_dir/.cms_scanner" ] || [ "$FORCE" = true ]; } && [ "$CMS_SCANNER" = true ]; then
    start_func "cms_scanner" "CMS Scanner"
    
    mkdir -p $dir/cms && rm -rf $dir/cms/*
    anew -q .tmp/webs_all.txt < <(cat webs/webs.txt webs/webs_uncommon_ports.txt 2>/dev/null)
    
    if [ -s ".tmp/webs_all.txt" ]; then
        tr '\n' ',' < .tmp/webs_all.txt > .tmp/cms.txt
        timeout -k 1m ${CMSSCAN_TIMEOUT}s python3 $tools/CMSeeK/cmseek.py -l .tmp/cms.txt --batch -r 2>>"$LOGFILE" &>/dev/null
        exit_status=$?
        if [[ $exit_status -eq 125 ]]; then
            echo "TIMEOUT cmseek.py - investigate manually for $dir" >> "$LOGFILE"
            end_func "TIMEOUT cmseek.py - investigate manually for $dir" "cms_scanner"
            exit 1
        elif [[ $exit_status -ne 0 ]]; then
            echo "ERROR cmseek.py - investigate manually for $dir" >> "$LOGFILE"
            end_func "ERROR cmseek.py - investigate manually for $dir" "cms_scanner"
            exit 1
        fi
        while read -r sub; do
            sub_out=$(echo "$sub" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
            cms_id=$(jq -r 'try .cms_id' "$tools/CMSeeK/Result/${sub_out}/cms.json" 2>/dev/null)
            if [ -z "$cms_id" ]; then
                rm -rf "$tools/CMSeeK/Result/${sub_out}"
            else
                mv -f "$tools/CMSeeK/Result/${sub_out}" $dir/cms/ 2>>"$LOGFILE"
            fi
        done < .tmp/webs_all.txt
        
        end_func "Results are saved in $domain/cms/*subdomain* folder" "cms_scanner"
    else
        end_func "No $domain/web/webs.txts file found, cms scanner skipped" "cms_scanner"
    fi
else
    if [ "$CMS_SCANNER" = false ]; then
        printf "\n${yellow} cms_scanner skipped in this mode or defined in reconftw.cfg ${reset}\n"
    else
        printf "${yellow} cms_scanner is already processed. To force executing cms_scanner, delete\n    $called_fn_dir/.cms_scanner ${reset}\n\n"
    fi
fi
