#!/bin/bash

# Load environment variables from reconftw.cfg
# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

# Colors
yellow="\033[1;33m"
red="\033[1;31m"
reset="\033[0m"

# Help menu function
function display_help() {
    echo "Usage: $0 [OPTIONS] [SCOPE_FILE] [TARGET_FILE]"
    echo
    echo "Remove out-of-scope items from a target file based on a scope file."
    echo "Options:"
    echo "  -h, --help    Display this help and exit"
    echo
}

# Validate arguments function
function validate_args() {
    if [[ -z "$1" || -z "$2" ]]; then
        echo -e "${red}Error: Both SCOPE_FILE and TARGET_FILE are required.${reset}"
        display_help
        exit 1
    fi

    if [[ ! -f "$1" ]]; then
        echo -e "${red}Error: SCOPE_FILE '$1' does not exist.${reset}"
        exit 1
    fi

    if [[ ! -f "$2" ]]; then
        echo -e "${red}Error: TARGET_FILE '$2' does not exist.${reset}"
        exit 1
    fi
}

# Delete out-of-scope items function
function delete_out_scoped() {
    local scope_file="$1"
    local target_file="$2"

    if [ -s "$scope_file" ]; then
        while IFS= read -r outscoped
        do
            if grep -q "^[*]" <<< "$outscoped"; then
                outscoped="${outscoped:1}"
                sed -i "/$outscoped$/d" "$target_file"
            else
                sed -i "/$outscoped/d" "$target_file"
            fi
        done < "$scope_file"
    fi
}

# Main script execution
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    display_help
    exit 0
fi

validate_args "$1" "$2"
delete_out_scoped "$1" "$2"
echo -e "${yellow}Processed $2 based on out-of-scope items from $1.${reset}"
